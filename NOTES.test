# Make baseline (seed) test data using flight Ska.
#
# NORMALLY THIS IS NOT DONE, just use available flight regression data.
#
############
ska
cd /proj/sot/ska/share/eng_archive
export ENG_ARCHIVE=$PWD/test/eng_archive
mkdir -p test/eng_archive
rm -rf test/eng_archive/*

rm -f test/make_eng_archive.log
touch test/make_eng_archive.log

echo "Making regr data..."
./make_regr_data.py --start 2012:290 --stop 2012:300 --data-root test/eng_archive > test/make_eng_archive.log 2>&1

echo "Tarring..."
pushd test
tar zcf eng_archive.tar.gz eng_archive
cp eng_archive.tar.gz /proj/sot/ska/data/eng_archive/regr/flight_eng_archive.tar.gz
popd


########################################################################################################
######## Regression test for primary (HEAD) update_archive.py and fetch.py
########################################################################################################

# First make test data.  This sets ENG_ARCHIVE in that window.

[[ source make_test_eng_archive.csh ]]
. make_test_eng_archive.sh   # THIS actually works now

# Basic sanity test with some plots

[[ setenv ENG_ARCHIVE $PWD/test/eng_archive ]]
export ENG_ARCHIVE=$PWD/test/eng_archive

test/make_plots.py

# Regression test.  Get_regr_vals.py uses the local ../Ska/engarchive/fetch.py
# if --test is given, otherwise uses the installed Ska version.  It sets
# ENG_ARCHIVE internally prior to importing fetch.

[[ unsetenv ENG_ARCHIVE ]]
unset ENG_ARCHIVE

cd test
  ./get_regr_vals.py --start 2012:302 --stop 2012:315
  ./get_regr_vals.py --start 2012:302 --stop 2012:315 --test
  ./compare_regr_vals.py
cd ..
[[ setenv ENG_ARCHIVE $PWD/test/eng_archive ]]
export ENG_ARCHIVE=$PWD/test/eng_archive

## 2011-Feb-18: All tests pass for rev 56:5b12e819e1df
## 2012-Jan-21: All tests pass for 0.16dev e359acd5 !!
## 2012-Apr-29: All tests pass for 0.18dev efddf4d
## 2012-Nov-27: All tests pass for 0.21

########################################################################################################
######## Regression test for new skare (updated Python, NumPy, tables, etc) in $ska/dev/
########################################################################################################

## WINDOW 2
############
# Now update using devska
skadev

. make_test_eng_archive.sh   # THIS actually works now

# Basic sanity test with some plots
test/make_plots.py

pushd test
./get_regr_vals.py --start 2010:265 --stop 2010:285 --test 
popd

## WINDOW 1
############
# Regression test.  Get_regr_vals.py uses the local ../Ska/engarchive/fetch.py
# if --test is given, otherwise uses the installed Ska version.  It sets
# ENG_ARCHIVE internally prior to importing fetch.
unsetenv ENG_ARCHIVE
pushd test
./get_regr_vals.py --start 2010:265 --stop 2010:285
./compare_regr_vals.py
cp -p regr_vals.flight regr_vals.7cb31b.flight  # git commit ID of current flight Skare
popd

## 2011-Jun-20 All tests pass for devska (skare 0.10)
## 2012-Jun-12 All tests pass in skatest (skare 0.13) + new eng archive ddc63d2
## 2012-Jun-20 All tests pass in skatest skare 0.13-r241-427bb9c + eng_arch ddc63d2

########################################################################################################
######## Regression test for new skare in /proj/sot/ska
########################################################################################################

# Make baseline (seed) test data using flight Ska. 

ska

setenv ENG_ARCHIVE $PWD/test/eng_archive
mkdir -p test/eng_archive
rm -rf test/eng_archive/*

rm -f test/make_eng_archive.log
touch test/make_eng_archive.log

## If no previous tarfile is available:
echo "Making regr data..."
./make_regr_data.py --start 2010:260 --stop 2010:270 --data-root test/eng_archive >>& test/make_eng_archive.log

echo "Tarring..."
pushd test
tar zcf eng_archive.tar.gz eng_archive
popd

## If a previous tarfile is available (recommended)
echo "Restoring tar..."
pushd test
tar xf eng_archive.<previous>.tar.gz
popd

setenv ENG_ARCHIVE $PWD/test/eng_archive
set EA=/proj/sot/ska/share/eng_archive
$EA/update_archive.py --date-now 2010:271 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:272 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:273 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:274 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:275 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:276 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:277 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:278 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:279 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:280 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:281 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:282 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:283 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:284 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:285 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:286 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:287 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:288 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:289 --data-root test/eng_archive >>& test/make_eng_archive.log
$EA/update_archive.py --date-now 2010:290 --data-root test/eng_archive >>& test/make_eng_archive.log

# Basic sanity test with some plots
test/make_plots.py

############
# Regression test.  Get_regr_vals.py uses the local ../Ska/engarchive/fetch.py
# if --test is given, otherwise uses the installed Ska version.  It sets
# ENG_ARCHIVE internally prior to importing fetch.

unsetenv ENG_ARCHIVE
pushd test
./get_regr_vals.py --start 2010:265 --stop 2010:285 --test 
./get_regr_vals.py --start 2010:265 --stop 2010:285
./compare_regr_vals.py
popd



########################################################################################################
######## OCC functionality testing
########################################################################################################

source make_test_eng_archive.csh
mv test/eng_archive test/eng_archive.head

rm -rf test/eng_archive_occ
rm -rf test/eng_archive 
tar -x -C test -f test/eng_archive.tar.gz 
cp -rp test/eng_archive test/eng_archive_occ

rm -f test/make_eng_archive.log
rm -f test/make_eng_archive_occ.log
touch test/make_eng_archive.log
touch test/make_eng_archive_occ.log

foreach doy (271 272 273 274 275 276 277 278 279 280 )
  setenv ENG_ARCHIVE $PWD/test/eng_archive
  ./update_archive.py --date-now "2010:$doy" --data-root $ENG_ARCHIVE >>& test/make_eng_archive.log
  ./transfer_stage.py --data-root $ENG_ARCHIVE >>& test/make_eng_archive.log

  setenv ENG_ARCHIVE $PWD/test/eng_archive_occ
  ./transfer_stage.py --data-root $ENG_ARCHIVE --occ >>& test/make_eng_archive_occ.log
  ./update_archive.py --date-now "2010:$doy" --data-root $ENG_ARCHIVE --occ >>& test/make_eng_archive_occ.log
end

# Regression tests:
# diff logs (after cutting time columns and replacing _occ with ""): No diffs seen
# diff "ls -l" from respective MSID and 5min directories.  Only diffs in times seen.
# diff binary MSID files.  Some diffs seens...

cd test
  unsetenv ENG_ARCHIVE
  ./get_regr_vals.py --start 2010:265 --stop 2010:279
  setenv ENG_ARCHIVE $PWD/eng_archive_occ
  ./get_regr_vals.py --test --start 2010:265 --stop 2010:279
  ./compare_regr_vals.py
cd ..

## 2011-Feb-18: All tests pass for rev 56:5b12e819e1df
## 2011-Feb-20: All tests pass for rev 60
