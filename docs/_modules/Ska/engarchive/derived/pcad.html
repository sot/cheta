
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ska.engarchive.derived.pcad &#8212; Eng archive 4.55.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">Ska! </span><span id="logotext2">Cheta</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">Eng archive 4.55.2 documentation</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Ska.engarchive.derived.pcad</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Derived parameter MSIDs related to PCAD subsystem.</span>

<span class="sd">Author: A. Arvai</span>

<span class="sd">Revision History::</span>

<span class="sd">     Jan 2012       Initial version</span>
<span class="sd">   1 Mar 2012       Modified all ephemeris-based parameters to use predictive</span>
<span class="sd">                    ephemeris</span>
<span class="sd">  26 Mar 2012       Re-defined DP_ROLL_FSS and DP_PITCH_FSS to improve accuracy</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">arctan2</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">radians</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span>


<span class="k">class</span> <span class="nc">DerivedParameterPcad</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DerivedParameter</span><span class="p">):</span>
    <span class="n">content_root</span> <span class="o">=</span> <span class="s1">&#39;pcad&#39;</span>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_CSS1_NPM_SUN"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_CSS1_NPM_SUN">[docs]</a><span class="k">class</span> <span class="nc">DP_CSS1_NPM_SUN</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coarse Sun Sensor Counts 1 filtered for NPM and SA Illuminated</span>

<span class="sd">    Defined as CSS-1 current converted back into counts</span>
<span class="sd">    (AOCSSI1 * 4095 / 5.49549) when in NPM (AOPCADMD==1) and SA is illuminated</span>
<span class="sd">    (AOSAILLM==1).  Otherwise, &quot;Bads&quot; flag is set equal to one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aocssi1&#39;</span><span class="p">,</span> <span class="s1">&#39;aopcadmd&#39;</span><span class="p">,</span> <span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">npm_sun</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aopcadmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;ILLM&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|</span> <span class="o">~</span><span class="n">npm_sun</span>
        <span class="n">css1_npm_sun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aocssi1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">*</span> <span class="mi">4095</span> <span class="o">/</span> <span class="mf">5.49549</span>
        <span class="k">return</span> <span class="n">css1_npm_sun</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_CSS2_NPM_SUN"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_CSS2_NPM_SUN">[docs]</a><span class="k">class</span> <span class="nc">DP_CSS2_NPM_SUN</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coarse Sun Sensor Counts 2 filtered for NPM and SA Illuminated</span>

<span class="sd">    Defined as CSS-2 current converted back into counts</span>
<span class="sd">    (AOCSSI2 * 4095 / 5.49549) when in NPM (AOPCADMD==1) and SA is illuminated</span>
<span class="sd">    (AOSAILLM==1).  Otherwise, &quot;Bads&quot; flag is set equal to one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aocssi2&#39;</span><span class="p">,</span> <span class="s1">&#39;aopcadmd&#39;</span><span class="p">,</span> <span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">npm_sun</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aopcadmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;ILLM&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|</span> <span class="o">~</span><span class="n">npm_sun</span>
        <span class="n">css2_npm_sun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aocssi2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">*</span> <span class="mi">4095</span> <span class="o">/</span> <span class="mf">5.49549</span>
        <span class="k">return</span> <span class="n">css2_npm_sun</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_CSS3_NPM_SUN"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_CSS3_NPM_SUN">[docs]</a><span class="k">class</span> <span class="nc">DP_CSS3_NPM_SUN</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coarse Sun Sensor Counts 3 filtered for NPM and SA Illuminated</span>

<span class="sd">    Defined as CSS-3 current converted back into counts</span>
<span class="sd">    (AOCSSI3 * 4095 / 5.49549) when in NPM (AOPCADMD==1) and SA is illuminated</span>
<span class="sd">    (AOSAILLM==1).  Otherwise, &quot;Bads&quot; flag is set equal to one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aocssi3&#39;</span><span class="p">,</span> <span class="s1">&#39;aopcadmd&#39;</span><span class="p">,</span> <span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">npm_sun</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aopcadmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;ILLM&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|</span> <span class="o">~</span><span class="n">npm_sun</span>
        <span class="n">css3_npm_sun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aocssi3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">*</span> <span class="mi">4095</span> <span class="o">/</span> <span class="mf">5.49549</span>
        <span class="k">return</span> <span class="n">css3_npm_sun</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_CSS4_NPM_SUN"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_CSS4_NPM_SUN">[docs]</a><span class="k">class</span> <span class="nc">DP_CSS4_NPM_SUN</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coarse Sun Sensor Counts 4 filtered for NPM and SA Illuminated</span>

<span class="sd">    Defined as CSS-4 current converted back into counts</span>
<span class="sd">    (AOCSSI4 * 4095 / 5.49549) when in NPM (AOPCADMD==1) and SA is illuminated</span>
<span class="sd">    (AOSAILLM==1).  Otherwise, &quot;Bads&quot; flag is set equal to one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aocssi4&#39;</span><span class="p">,</span> <span class="s1">&#39;aopcadmd&#39;</span><span class="p">,</span> <span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">npm_sun</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aopcadmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosaillm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;ILLM&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|</span> <span class="o">~</span><span class="n">npm_sun</span>
        <span class="n">css4_npm_sun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aocssi4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">*</span> <span class="mi">4095</span> <span class="o">/</span> <span class="mf">5.49549</span>
        <span class="k">return</span> <span class="n">css4_npm_sun</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_FSS_CSS_ANGLE_DIFF"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_FSS_CSS_ANGLE_DIFF">[docs]</a><span class="k">class</span> <span class="nc">DP_FSS_CSS_ANGLE_DIFF</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Angle between FSS and CSS Sun Vectors [Deg]</span>

<span class="sd">    Defined as the angle between the FSS and CSS sun vectors</span>

<span class="sd">    Calculated by rotating the CSS sun vector from the SA-1 frame to ACA frame</span>
<span class="sd">    then computing the angular difference using the dot product and ARCCOS.</span>
<span class="sd">    &quot;Bads&quot; flag is set equal to one when not in the FSS FOV.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa3&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aosunac1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunac2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunac3&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aosares1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosares2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunprs&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">18.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">in_fss_fov</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;SUN &#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="o">~</span><span class="n">in_fss_fov</span>
        <span class="n">sa_ang_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sinang</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">sa_ang_avg</span><span class="p">))</span>
        <span class="n">cosang</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">sa_ang_avg</span><span class="p">))</span>
        <span class="n">fss_aca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunac1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunac2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunac3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
        <span class="c1"># Rotate CSS sun vector from SA to ACA frame</span>
        <span class="n">css_aca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sinang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span>
                            <span class="n">cosang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">cosang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span>
                            <span class="n">sinang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
        <span class="c1"># Normalize the vectors (again)</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">fss_aca</span> <span class="o">*</span> <span class="n">fss_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">fss_aca</span> <span class="o">=</span> <span class="n">fss_aca</span> <span class="o">/</span> <span class="n">magnitude</span>

        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">css_aca</span> <span class="o">*</span> <span class="n">css_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">css_aca</span> <span class="o">=</span> <span class="n">css_aca</span> <span class="o">/</span> <span class="n">magnitude</span>

        <span class="c1"># Compute the angle between the vectors</span>
        <span class="n">dot_prod</span> <span class="o">=</span> <span class="p">(</span><span class="n">css_aca</span> <span class="o">*</span> <span class="n">fss_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fss_css_angle_diff</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arccos_clip</span><span class="p">(</span><span class="n">dot_prod</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">fss_css_angle_diff</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_MAN_ANG"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_MAN_ANG">[docs]</a><span class="k">class</span> <span class="nc">DP_MAN_ANG</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maneuver Angle (Total)  [deg]</span>

<span class="sd">    Defined as the  angle between the estimated quaternion and the target</span>
<span class="sd">    quaternion during a maneuver.</span>

<span class="sd">    Computed using the fourth component of the delta quaternion between</span>
<span class="sd">    AOTARQT&lt;N&gt; and AOATTQT&lt;N&gt; when a maneuver is in progress</span>
<span class="sd">    (AOMANEND = NEND), otherwise equal to zero.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aoattqt1&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt2&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt3&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt4&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aotarqt1&#39;</span><span class="p">,</span> <span class="s1">&#39;aotarqt2&#39;</span><span class="p">,</span> <span class="s1">&#39;aotarqt3&#39;</span><span class="p">,</span> <span class="s1">&#39;aomanend&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">qt4_sqr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aotarqt1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                         <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aotarqt2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                         <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aotarqt3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">aotarqt4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">qt4_sqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">est_quat_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                                 <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                                 <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
        <span class="n">tar_quat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aotarqt1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aotarqt2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aotarqt3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                             <span class="n">aotarqt4</span><span class="p">])</span>
        <span class="n">delta_quat</span> <span class="o">=</span> <span class="n">qmult</span><span class="p">(</span><span class="n">est_quat_inv</span><span class="p">,</span> <span class="n">tar_quat</span><span class="p">)</span>
        <span class="c1"># Normalize delta_quat due to roundoff errors.</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">delta_quat</span> <span class="o">*</span> <span class="n">delta_quat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">delta_quat3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_quat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">magnitude</span><span class="p">)</span>
        <span class="n">man_ang</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arccos_clip</span><span class="p">(</span><span class="n">delta_quat3</span><span class="p">))</span>

        <span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aomanend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;NEND&#39;</span><span class="p">)</span>
        <span class="n">man_ang</span><span class="p">[</span><span class="o">~</span><span class="n">man</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">man_ang</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_ONE_SHOT"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_ONE_SHOT">[docs]</a><span class="k">class</span> <span class="nc">DP_ONE_SHOT</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One Shot [arcsec]</span>

<span class="sd">    Defined as the RSS of AOATTER2 and AOATTER3 while in NPM and zero for all</span>
<span class="sd">    other PCAD modes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aoatter2&#39;</span><span class="p">,</span> <span class="s1">&#39;aoatter3&#39;</span><span class="p">,</span> <span class="s1">&#39;aopcadmd&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">one_shot</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoatter2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoatter3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="n">npm</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aopcadmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">)</span>
        <span class="n">one_shot</span><span class="p">[</span><span class="o">~</span><span class="n">npm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">one_shot</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_PITCH"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_PITCH">[docs]</a><span class="k">class</span> <span class="nc">DP_PITCH</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun Pitch Angle from Predictive Ephemeris in ACA Frame [deg]</span>

<span class="sd">    Defined as the angle between the sun vector and ACA X-axis.</span>

<span class="sd">    Calculated using arccos of the sun vector x component in the body frame</span>
<span class="sd">    where the sun vector is from predictive ephemeris</span>
<span class="sd">    [SOLAREPHEM0 and ORBITEPHEM0] and the estimated attitude from the OBC&#39;s</span>
<span class="sd">    estimated quaternion [AOATTQT&lt;n&gt;].</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;orbitephem0_x&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_y&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_z&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;solarephem0_x&#39;</span><span class="p">,</span> <span class="s1">&#39;solarephem0_y&#39;</span><span class="p">,</span> <span class="s1">&#39;solarephem0_z&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aoattqt1&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt2&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt3&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aoattqt4&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">max_gaps</span> <span class="o">=</span> <span class="p">{</span><span class="n">msid</span><span class="p">:</span> <span class="mf">602.0</span> <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">rootparams</span> <span class="k">if</span> <span class="s1">&#39;ephem&#39;</span> <span class="ow">in</span> <span class="n">msid</span><span class="p">}</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sun_vec_b</span> <span class="o">=</span> <span class="n">sun_vector_body</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arccos_clip</span><span class="p">(</span><span class="n">sun_vec_b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">pitch</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_PITCH_CSS"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_PITCH_CSS">[docs]</a><span class="k">class</span> <span class="nc">DP_PITCH_CSS</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun Pitch Angle from CSS Data in ACA Frame [Deg]</span>

<span class="sd">    Defined as the angle between the sun vector and ACA X-axis.</span>

<span class="sd">    Calculated by rotating the CSS sun vector from the SA-1 frame to ACA frame</span>
<span class="sd">    based on the solar array angles AOSARES1 and AOSARES2.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosares2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">4.1</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">18.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sa_ang_avg</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span>
                      <span class="mf">1.0</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sinang</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">sa_ang_avg</span><span class="p">))</span>
        <span class="n">cosang</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">sa_ang_avg</span><span class="p">))</span>
        <span class="c1"># Rotate CSS sun vector from SA to ACA frame</span>
        <span class="n">css_aca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sinang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span>
                            <span class="n">cosang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">cosang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span>
                            <span class="n">sinang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
        <span class="c1"># Normalize sun vec (again) and compute pitch</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">css_aca</span> <span class="o">*</span> <span class="n">css_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sun_vec_norm</span> <span class="o">=</span> <span class="n">css_aca</span> <span class="o">/</span> <span class="n">magnitude</span>
        <span class="n">pitch_css</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arccos_clip</span><span class="p">(</span><span class="n">sun_vec_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">pitch_css</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_PITCH_CSS_SA"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_PITCH_CSS_SA">[docs]</a><span class="k">class</span> <span class="nc">DP_PITCH_CSS_SA</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun Pitch Angle from CSS Data in SA Frame [Deg]</span>

<span class="sd">    Defined as the rotation about the SA-1 Y-axis required to align the sun</span>
<span class="sd">    vector with the SA-1 Y-Z plane.</span>

<span class="sd">    Calculated as 90.0 - ARCCOS(AOSUNSA1).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">8.2</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">18.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">pitch_css_sa</span> <span class="o">=</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arccos_clip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pitch_css_sa</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_PITCH_FSS"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_PITCH_FSS">[docs]</a><span class="k">class</span> <span class="nc">DP_PITCH_FSS</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun Pitch Angle from FSS Data in ACA Frame [Deg]</span>

<span class="sd">    Defined as the angle between the sun vector and ACA X-axis.</span>

<span class="sd">    When in FSS FOV per AOSUNPRS:</span>
<span class="sd">    Calculated using the FSS alpha and beta angles to compute the sun vector</span>
<span class="sd">    in the FSS frame.  The sun vector is then rotated into the ACA frame</span>
<span class="sd">    using the rotation matrix (an OBC k-constant).  Pitch is computed using the</span>
<span class="sd">    arccos function.</span>

<span class="sd">    When NOT in FSS FOV per AOSUNPRS:</span>
<span class="sd">    &lt;data&gt;.bads = 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aoalpang&#39;</span><span class="p">,</span> <span class="s1">&#39;aobetang&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunprs&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">in_fss_fov</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;SUN &#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|</span> <span class="o">~</span><span class="n">in_fss_fov</span>
        <span class="c1"># rotation matrix from FSS to ACA frame</span>
        <span class="n">A_AF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">9.999990450374580e-01</span><span class="p">,</span>
                          <span class="mf">0.0</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">1.382000062241829e-03</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mf">5.327615067743422e-07</span><span class="p">,</span>
                          <span class="mf">9.999999256947376e-01</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">3.854999811959735e-04</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">1.381999959551952e-03</span><span class="p">,</span>
                          <span class="mf">3.855003493343671e-04</span><span class="p">,</span>
                          <span class="mf">9.999989707322665e-01</span><span class="p">]])</span>
        <span class="c1"># FSS&#39;s sun vector in FSS frame</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoalpang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aobetang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">sun_fss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tan</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="n">tan</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">))])</span>
        <span class="n">sun_aca</span> <span class="o">=</span> <span class="n">A_AF</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sun_fss</span><span class="p">)</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">sun_aca</span> <span class="o">*</span> <span class="n">sun_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sun_vec_norm</span> <span class="o">=</span> <span class="n">sun_aca</span> <span class="o">/</span> <span class="n">magnitude</span>
        <span class="n">pitch_fss</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arccos_clip</span><span class="p">(</span><span class="n">sun_vec_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">pitch_fss</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_ROLL"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_ROLL">[docs]</a><span class="k">class</span> <span class="nc">DP_ROLL</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Off-Nominal Roll Angle in ACA Frame [Deg]</span>

<span class="sd">    Defined as the rotation about the ACA X-axis required to align the sun</span>
<span class="sd">    vector with the ACA X/Z plane.</span>

<span class="sd">    Calculated using the four-quadrant arctan of the sun vector y and z</span>
<span class="sd">    components in the ACA frame where the sun vector is from predictive</span>
<span class="sd">    ephemeris [SOLAREPHEM0 and ORBITEPHEM0] and the estimated attitude from</span>
<span class="sd">    the OBC&#39;s estimated quaternion [AOATTQT&lt;n&gt;].</span>

<span class="sd">    http://occweb.cfa.harvard.edu/twiki/pub/Aspect/WebHome/ROLLDEV3.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;orbitephem0_x&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_y&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_z&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;solarephem0_x&#39;</span><span class="p">,</span> <span class="s1">&#39;solarephem0_y&#39;</span><span class="p">,</span> <span class="s1">&#39;solarephem0_z&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aoattqt1&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt2&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt3&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt4&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">max_gaps</span> <span class="o">=</span> <span class="p">{</span><span class="n">msid</span><span class="p">:</span> <span class="mf">602.0</span> <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">rootparams</span> <span class="k">if</span> <span class="s1">&#39;ephem&#39;</span> <span class="ow">in</span> <span class="n">msid</span><span class="p">}</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sun_vec_b</span> <span class="o">=</span> <span class="n">sun_vector_body</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">sun_vec_b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">sun_vec_b</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">roll</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_ROLL_CSS"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_ROLL_CSS">[docs]</a><span class="k">class</span> <span class="nc">DP_ROLL_CSS</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Off-Nominal Roll Angle from CSS Data in ACA Frame [Deg]</span>

<span class="sd">    Defined as the rotation about the ACA X-axis required to align the sun</span>
<span class="sd">    vector with the ACA X/Z plane.</span>

<span class="sd">    Calculated by rotating the CSS sun vector from the SA-1 frame to ACA frame</span>
<span class="sd">    based on the solar array angles AOSARES1 and AOSARES2.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosares2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">4.1</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">18.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sa_ang_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sinang</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">sa_ang_avg</span><span class="p">))</span>
        <span class="n">cosang</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">sa_ang_avg</span><span class="p">))</span>
        <span class="c1"># Rotate CSS sun vector from SA to ACA frame</span>
        <span class="n">css_aca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sinang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span>
                            <span class="n">cosang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">cosang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span>
                            <span class="n">sinang</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
        <span class="c1"># Normalize sun vec (again) and compute pitch</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">css_aca</span> <span class="o">*</span> <span class="n">css_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sun_vec_norm</span> <span class="o">=</span> <span class="n">css_aca</span> <span class="o">/</span> <span class="n">magnitude</span>
        <span class="n">roll_css</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">sun_vec_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">sun_vec_norm</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">roll_css</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_ROLL_CSS_SA"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_ROLL_CSS_SA">[docs]</a><span class="k">class</span> <span class="nc">DP_ROLL_CSS_SA</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun Roll Angle from CSS Data in SA Frame [Deg]</span>

<span class="sd">    Defined as the rotation about the SA-1 X-axis required to align the sun</span>
<span class="sd">    vector with the SA-1 X-Z plane.</span>

<span class="sd">    Calculated as ARCTAN( (-1*AOSUNSA2) / (-1*AOSUNSA3) ) using the</span>
<span class="sd">    four-quadrant version of ARCTAN.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosunsa2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">8.2</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">18.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">roll_css_sa</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                                      <span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunsa3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">roll_css_sa</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_ROLL_FSS"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_ROLL_FSS">[docs]</a><span class="k">class</span> <span class="nc">DP_ROLL_FSS</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Off-Nominal Roll Angle from FSS Data in ACA Frame [Deg]</span>

<span class="sd">    Defined as the rotation about the ACA X-axis required to align the sun</span>
<span class="sd">    vector with the ACA X/Z plane.</span>

<span class="sd">    When in FSS FOV per AOSUNPRS:</span>
<span class="sd">    Calculated using the FSS alpha and beta angles to compute the sun vector</span>
<span class="sd">    in the FSS frame.  The sun vector is then rotated into the ACA frame</span>
<span class="sd">    using the rotation matrix (an OBC k-constant).  Roll is computed using the</span>
<span class="sd">    arctan function.</span>

<span class="sd">    When NOT in FSS FOV per AOSUNPRS:</span>
<span class="sd">    &lt;data&gt;.bads = 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aoalpang&#39;</span><span class="p">,</span> <span class="s1">&#39;aobetang&#39;</span><span class="p">,</span> <span class="s1">&#39;aosunprs&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">in_fss_fov</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosunprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s1">&#39;SUN &#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|</span> <span class="o">~</span><span class="n">in_fss_fov</span>
        <span class="c1"># rotation matrix from FSS to ACA frame</span>
        <span class="n">A_AF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">9.999990450374580e-01</span><span class="p">,</span>
                          <span class="mf">0.0</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">1.382000062241829e-03</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mf">5.327615067743422e-07</span><span class="p">,</span>
                          <span class="mf">9.999999256947376e-01</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">3.854999811959735e-04</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">1.381999959551952e-03</span><span class="p">,</span>
                          <span class="mf">3.855003493343671e-04</span><span class="p">,</span>
                          <span class="mf">9.999989707322665e-01</span><span class="p">]])</span>
        <span class="c1"># FSS&#39;s sun vector in FSS frame</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoalpang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aobetang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">sun_fss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tan</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="n">tan</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">))])</span>
        <span class="n">sun_aca</span> <span class="o">=</span> <span class="n">A_AF</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sun_fss</span><span class="p">)</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">sun_aca</span> <span class="o">*</span> <span class="n">sun_aca</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sun_vec_norm</span> <span class="o">=</span> <span class="n">sun_aca</span> <span class="o">/</span> <span class="n">magnitude</span>
        <span class="n">roll_fss</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">sun_vec_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">sun_vec_norm</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">roll_fss</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW_MOM_TOT"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW_MOM_TOT">[docs]</a><span class="k">class</span> <span class="nc">DP_RW_MOM_TOT</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Total Reaction Wheel Momentum [Ft-Lb-Sec]</span>

<span class="sd">    Defined as the RSS of AORWMOM1, AORWMOM2, and AORWMOM3.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aorwmom1&#39;</span><span class="p">,</span> <span class="s1">&#39;aorwmom2&#39;</span><span class="p">,</span> <span class="s1">&#39;aorwmom3&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">8.2</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw_mom_tot</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aorwmom1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                          <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aorwmom2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                          <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aorwmom3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rw_mom_tot</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW1_DELTA_TEMP"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW1_DELTA_TEMP">[docs]</a><span class="k">class</span> <span class="nc">DP_RW1_DELTA_TEMP</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Difference between Reaction Wheel 1 Compartment and Bearing Temperature</span>
<span class="sd">    [Deg F]</span>

<span class="sd">    Defined as TCYZ_RW1 - ARWA1BT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tcyz_rw1&#39;</span><span class="p">,</span> <span class="s1">&#39;arwa1bt&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.25625</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw1_delta_temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tcyz_rw1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arwa1bt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span>
        <span class="k">return</span> <span class="n">rw1_delta_temp</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW2_DELTA_TEMP"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW2_DELTA_TEMP">[docs]</a><span class="k">class</span> <span class="nc">DP_RW2_DELTA_TEMP</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Difference between Reaction Wheel 2 Compartment and Bearing Temperature</span>
<span class="sd">    [Deg F]</span>

<span class="sd">    Defined as TPCP_RW2 - ARWA2BT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tpcp_rw2&#39;</span><span class="p">,</span> <span class="s1">&#39;arwa2bt&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.25625</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw2_delta_temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tpcp_rw2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arwa2bt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span>
        <span class="k">return</span> <span class="n">rw2_delta_temp</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW3_DELTA_TEMP"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW3_DELTA_TEMP">[docs]</a><span class="k">class</span> <span class="nc">DP_RW3_DELTA_TEMP</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Difference between Reaction Wheel 3 Compartment and Bearing Temperature</span>
<span class="sd">    [Deg F]</span>

<span class="sd">    Defined as TPCP_RW3 - ARWA3BT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tpcp_rw3&#39;</span><span class="p">,</span> <span class="s1">&#39;arwa3bt&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.25625</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw3_delta_temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tpcp_rw3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arwa3bt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span>
        <span class="k">return</span> <span class="n">rw3_delta_temp</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW4_DELTA_TEMP"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW4_DELTA_TEMP">[docs]</a><span class="k">class</span> <span class="nc">DP_RW4_DELTA_TEMP</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Difference between Reaction Wheel 4 Compartment and Bearing Temperature</span>
<span class="sd">    [Deg F]</span>

<span class="sd">    Defined as TPCM_RW4 - ARWA4BT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tpcm_rw4&#39;</span><span class="p">,</span> <span class="s1">&#39;arwa4bt&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.25625</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw4_delta_temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tpcm_rw4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arwa4bt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span>
        <span class="k">return</span> <span class="n">rw4_delta_temp</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW5_DELTA_TEMP"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW5_DELTA_TEMP">[docs]</a><span class="k">class</span> <span class="nc">DP_RW5_DELTA_TEMP</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Difference between Reaction Wheel 5 Compartment and Bearing Temperature</span>
<span class="sd">    [Deg F]</span>

<span class="sd">    Defined as TPCM_RW5 - ARWA5BT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tpcm_rw5&#39;</span><span class="p">,</span> <span class="s1">&#39;arwa5bt&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.25625</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw5_delta_temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tpcm_rw5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arwa5bt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span>
        <span class="k">return</span> <span class="n">rw5_delta_temp</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_RW6_DELTA_TEMP"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_RW6_DELTA_TEMP">[docs]</a><span class="k">class</span> <span class="nc">DP_RW6_DELTA_TEMP</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Difference between Reaction Wheel 6 Compartment and Bearing Temperature</span>
<span class="sd">    [Deg F]</span>

<span class="sd">    Defined as TCYZ_RW6 - ARWA6BT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tcyz_rw6&#39;</span><span class="p">,</span> <span class="s1">&#39;arwa6bt&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.25625</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rw6_delta_temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tcyz_rw6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arwa6bt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span>
        <span class="k">return</span> <span class="n">rw6_delta_temp</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_SA_ANG_AVG"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_SA_ANG_AVG">[docs]</a><span class="k">class</span> <span class="nc">DP_SA_ANG_AVG</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Average Solar Array Angle [Deg]</span>

<span class="sd">    Defined as the mean of AOSARES1 and AOSARES2.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosares2&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">4.1</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sa_ang_avg</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">+</span>
                      <span class="mf">1.0</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosares2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">sa_ang_avg</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_SUN_XZ_ANGLE"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_SUN_XZ_ANGLE">[docs]</a><span class="k">class</span> <span class="nc">DP_SUN_XZ_ANGLE</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Angle between Sun and ACA X/Z plane [Deg]</span>

<span class="sd">    Incidence angle of the Sun vector on the ACA X/Z plane.</span>

<span class="sd">    Calculated using the four-quadrant arctan of the sun vector y and z</span>
<span class="sd">    components in the ACA frame where the sun vector is from definitive</span>
<span class="sd">    ephemeris [SOLAREPHEM0 and ORBITEPHEM0] and the estimated attitude from</span>
<span class="sd">    the OBC&#39;s estimated quaternion [AOATTQT&lt;n&gt;].</span>

<span class="sd">    http://occweb.cfa.harvard.edu/twiki/pub/Aspect/WebHome/ROLLDEV3.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;orbitephem0_x&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_y&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_z&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;solarephem0_x&#39;</span><span class="p">,</span> <span class="s1">&#39;solarephem0_y&#39;</span><span class="p">,</span> <span class="s1">&#39;solarephem0_z&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aoattqt1&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt2&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt3&#39;</span><span class="p">,</span> <span class="s1">&#39;aoattqt4&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">1.025</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">max_gaps</span> <span class="o">=</span> <span class="p">{</span><span class="n">msid</span><span class="p">:</span> <span class="mf">602.0</span> <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">rootparams</span> <span class="k">if</span> <span class="s1">&#39;ephem&#39;</span> <span class="ow">in</span> <span class="n">msid</span><span class="p">}</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sun_vec_b</span> <span class="o">=</span> <span class="n">sun_vector_body</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sun_xz_angle</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sun_vec_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">sqrt</span><span class="p">(</span><span class="n">sun_vec_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                            <span class="n">sun_vec_b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">sun_xz_angle</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="DP_SYS_MOM_TOT"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.DP_SYS_MOM_TOT">[docs]</a><span class="k">class</span> <span class="nc">DP_SYS_MOM_TOT</span><span class="p">(</span><span class="n">DerivedParameterPcad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Total System Momentum [Ft-Lb-Sec]</span>

<span class="sd">    Defined as the sum of the reaction wheel, environmental, and spacecraft</span>
<span class="sd">    momentum.</span>

<span class="sd">    Calculated as the RSS of AOSYMOM1, AOSYMOM2, and AOSYMOM3.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rootparams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aosymom1&#39;</span><span class="p">,</span> <span class="s1">&#39;aosymom2&#39;</span><span class="p">,</span> <span class="s1">&#39;aosymom3&#39;</span><span class="p">]</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="mf">8.2</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mf">18.0</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">sys_mom_tot</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosymom1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                           <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosymom2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                           <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aosymom3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sys_mom_tot</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="qmult"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.qmult">[docs]</a><span class="k">def</span> <span class="nf">qmult</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiply two quaternions or arrays of quaternions</span>

<span class="sd">    The input quaternions must have shape of (4,) or (4, N, ..).</span>

<span class="sd">    :param q1: first quaternion</span>
<span class="sd">    :param q2: second quaternion</span>
<span class="sd">    :returns: q1*q2 as an array with same shape as q1 and q2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">q1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">q2</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Shapes must agree&#39;</span><span class="p">)</span>

    <span class="n">mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">mult</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">mult</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">mult</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">mult</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">q2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mult</span></div>


<span class="c1"># --------------------------------------------</span>
<div class="viewcode-block" id="qrotate"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.qrotate">[docs]</a><span class="k">def</span> <span class="nf">qrotate</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a vector by a quaternion</span>

<span class="sd">    The input quaternion must have a shape of (4,) or (4, N, ..).</span>

<span class="sd">    The input vector must have a shape of (3,) or (3, N, ..).</span>

<span class="sd">    :param q:  quaternion defining the rotation</span>
<span class="sd">    :param r:  vector to be rotated</span>

<span class="sd">    :returns r rotated by q as an array with the same shape as r</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input quaternion must have shape (4,) or (4, N, ..)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input vector must have shape (3,) or (3, N, ..).&#39;</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
              <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
              <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span>
              <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
              <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
              <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span>
              <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">rot</span></div>


<span class="k">def</span> <span class="nf">arccos_clip</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


<div class="viewcode-block" id="sun_vector_body"><a class="viewcode-back" href="../../../../pseudo_msids.html#Ska.engarchive.derived.pcad.sun_vector_body">[docs]</a><span class="k">def</span> <span class="nf">sun_vector_body</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the normalized sun vector in body coordinates.</span>

<span class="sd">    :param data: MSIDset with orbitephem, solarephem and aoattqt&lt;N&gt; MSIDs</span>
<span class="sd">    :param predictive: use predictive ephemeris</span>
<span class="sd">    :returns: 3 x N array of vectors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orbit</span> <span class="o">=</span> <span class="s1">&#39;orbitephem</span><span class="si">{}</span><span class="s1">_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">predictive</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">solar</span> <span class="o">=</span> <span class="s1">&#39;solarephem</span><span class="si">{}</span><span class="s1">_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">predictive</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="n">chandra_eci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">orbit</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">orbit</span> <span class="o">+</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">orbit</span> <span class="o">+</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
    <span class="n">sun_eci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">solar</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">solar</span> <span class="o">+</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">solar</span> <span class="o">+</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>
    <span class="n">sun_vec</span> <span class="o">=</span> <span class="o">-</span><span class="n">chandra_eci</span> <span class="o">+</span> <span class="n">sun_eci</span>
    <span class="n">est_quat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">[</span><span class="s1">&#39;aoattqt4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span><span class="p">])</span>

    <span class="n">sun_vec_b</span> <span class="o">=</span> <span class="n">qrotate</span><span class="p">(</span><span class="n">est_quat</span><span class="p">,</span> <span class="n">sun_vec</span><span class="p">)</span>  <span class="c1"># Rotate into body frame</span>
    <span class="n">magnitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">sun_vec_b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">bads</span> <span class="o">|=</span> <span class="n">magnitude</span> <span class="o">==</span> <span class="mf">0.0</span>
    <span class="n">magnitude</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bads</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">sun_vec_b</span> <span class="o">=</span> <span class="n">sun_vec_b</span> <span class="o">/</span> <span class="n">magnitude</span>  <span class="c1"># Normalize</span>

    <span class="k">return</span> <span class="n">sun_vec_b</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/ska.png" alt="Logo"/>
            </a></p><h3>Page Contents</h3>


<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.2.0. &nbsp;
  </p>
</footer>
  </body>
</html>